#
# =================================================================
#         ImmortalWrt x86-64 固件编译 (极限空间优化版)
# =================================================================
#
# 特性:
#   - 平台: x86-64
#   - 文件系统: EXT4 (可读写)
#   - 固件大小: 1GB
#   - 引导方式: EFI
#   - 插件支持: Passwall2 官方源
#   - 编译优化:
#     1. 预安装 Rust 编译器，避免内存耗尽
#     2. 极限清理 Runner 环境，释放最大磁盘空间，避免磁盘耗尽
#
# =================================================================
#

name: Build ImmortalWrt (x86-64, EXT4, 1GB, Official-Passwall2)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ImmortalWrt version (branch)'
        required: true
        default: 'openwrt-23.05'
      packages:
        description: 'Extra packages (use space to separate)'
        required: false
        default: 'luci luci-i18n-base-zh-cn luci-app-upnp luci-app-passwall2 luci-app-vlmcsd luci-theme-argon'
      release:
        description: 'Release firmware to Github Releases'
        required: true
        default: 'true'

  schedule:
    - cron: '0 16 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: ${{ github.event.inputs.version || 'openwrt-23.05' }}
  EXTRA_PACKAGES: ${{ github.event.inputs.packages || 'luci luci-i18n-base-zh-cn luci-app-upnp luci-app-passwall2 luci-app-vlmcsd luci-theme-argon' }}
  CONFIG_FILE: .config
  FIRMWARE_TAG: ImmortalWrt-x86-EXT4-1GB-Official-Passwall2

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # --- 【核心修正：极限清理磁盘空间】 ---
    - name: Maximize build space
      run: |
        echo "Starting disk space cleanup..."
        df -h
        # 卸载不需要的包
        sudo apt-get purge -y azure-cli* gh* google* dotnet* powershell* openjdk*
        sudo apt-get autoremove -y
        sudo apt-get clean
        # 删除大型预装工具
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/local/share/boost
        # 删除 Actions 工具缓存
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        # 清理 Docker 镜像
        sudo docker rmi $(docker images -q) || true
        echo "Cleanup complete. Available space:"
        df -h
    # ----------------------------------------

    - name: Install build dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 aria2 autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mlocate mt-st quilt rsync subversion swig texinfo uglifyjs upx-ucl unzip vim-common wget xmlto xxd zlib1g-dev

    - name: Install Rust Toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: Clone source code
      run: git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt

    - name: Add official passwall2 feed by xiaorouji
      run: |
        cd openwrt
        echo "src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2" >> feeds.conf.default

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate .config for PVE (EXT4, 1GB)
      run: |
        cd openwrt
        echo "CONFIG_TARGET_x86=y" > $CONFIG_FILE
        echo "CONFIG_TARGET_x86_64=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_DEVICE_x86_64_Generic=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> $CONFIG_FILE
        echo "CONFIG_GRUB_EFI_IMAGES=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IMAGES_EXT4=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IMAGES_SQUASHFS=n" >> $CONFIG_FILE
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> $CONFIG_FILE
        
        if [ -n "$EXTRA_PACKAGES" ]; then
          echo "$EXTRA_PACKAGES" | sed 's/ /\n/g' >> extra_packages.list
          echo -e "\n# Add extra packages" >> $CONFIG_FILE
          while read -r package; do
            echo "CONFIG_PACKAGE_${package}=y" >> $CONFIG_FILE
          done < extra_packages.list
        fi
        make defconfig

    - name: Download package
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build firmware
      run: |
        cd openwrt
        echo -e "$(nproc) thread build."
        make -j$(nproc)

    - name: Organize files
      id: organize
      run: |
        cd openwrt
        FIRMWARE_DIR="bin/targets/x86/64"
        mkdir -p firmware
        cp -f $FIRMWARE_DIR/*-combined-efi.img.gz firmware/
        echo "FIRMWARE_PATH=openwrt/firmware" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_TAG }}-${{ github.run_id }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: Create release
      if: (github.event_name == 'schedule') || (github.event.inputs.release == 'true') && steps.organize.outputs.status == 'success'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.run_id }}
        body: |
          - Platform: x86/64
          - Filesystem: EXT4 (Writable)
          - Firmware Size: ~1GB
          - Branch: ${{ env.REPO_BRANCH }}
          - Packages: ${{ env.EXTRA_PACKAGES }}
        files: ${{ env.FIRMWARE_PATH }}/*
