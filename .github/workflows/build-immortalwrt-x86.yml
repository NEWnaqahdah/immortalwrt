#
# =================================================================
#         ImmortalWrt x86-64 固件编译 GitHub Actions (最终完善版)
# =================================================================
#
# 特性:
#   - 平台: x86-64
#   - 文件系统: EXT4 (完全可读写，为 PVE/ESXi 等虚拟机环境优化)
#   - 固件大小: 1GB (1024MB), 提供充足插件空间
#   - 触发方式: 手动触发 或 每周一凌晨 0 点 (北京时间) 自动更新
#   - 引导方式: EFI (现代 x86 设备标准)
#   - 脚本优化: 移除所有冗余代码，逻辑清晰严谨
#
# =================================================================
#

name: Build ImmortalWrt (x86-64, EXT4, 1GB)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ImmortalWrt version (branch)'
        required: true
        default: 'openwrt-23.05'
      packages:
        description: 'Extra packages (use space to separate)'
        required: false
        default: 'xray-core dnsmasq-full ipset kmod-r8125 kmod-igc kmod-nft-socket kmod-nft-tproxy luci luci-i18n-base-zh-cn luci-app-upnp luci-app-passwall2 luci-app-vlmcsd luci-theme-argon openssh-sftp-server automount'
      release:
        description: 'Release firmware to Github Releases'
        required: true
        default: 'true'

  schedule:
    - cron: '0 16 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: ${{ github.event.inputs.version || 'openwrt-23.05' }}
  EXTRA_PACKAGES: ${{ github.event.inputs.packages || 'luci luci-i18n-base-zh-cn luci-app-upnp luci-app-passwall2 luci-app-vlmcsd luci-theme-argon' }}
  CONFIG_FILE: .config
  FIRMWARE_TAG: ImmortalWrt-x86-EXT4-1GB

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 aria2 autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mlocate mt-st quilt rsync subversion swig texinfo uglifyjs upx-ucl unzip vim-common wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean

    - name: Free up disk space
      run: |
        sudo docker rmi $(docker images -q)
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    - name: Clone source code
      run: git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate .config for PVE (EXT4, 1GB)
      run: |
        cd openwrt
        echo "CONFIG_TARGET_x86=y" > $CONFIG_FILE
        echo "CONFIG_TARGET_x86_64=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_DEVICE_x86_64_Generic=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> $CONFIG_FILE
        echo "CONFIG_GRUB_EFI_IMAGES=y" >> $CONFIG_FILE

        # --- 【关键配置】确保生成适用于 PVE 的可读写固件 ---
        # 1. 强制使用 EXT4 可读写文件系统
        echo "CONFIG_TARGET_IMAGES_EXT4=y" >> $CONFIG_FILE
        # 2. 明确禁止编译只读的 SquashFS 格式
        echo "CONFIG_TARGET_IMAGES_SQUASHFS=n" >> $CONFIG_FILE
        # 3. 设置根分区大小，决定最终固件总大小约为 1GB
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> $CONFIG_FILE
        # ----------------------------------------------------
        
        if [ -n "$EXTRA_PACKAGES" ]; then
          echo "$EXTRA_PACKAGES" | sed 's/ /\n/g' >> extra_packages.list
          echo -e "\n# Add extra packages" >> $CONFIG_FILE
          while read -r package; do
            echo "CONFIG_PACKAGE_${package}=y" >> $CONFIG_FILE
          done < extra_packages.list
        fi
        make defconfig

    - name: Download package
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build firmware
      run: |
        cd openwrt
        echo -e "$(nproc) thread build."
        make -j$(nproc)

    - name: Organize files (Optimized)
      id: organize
      run: |
        cd openwrt
        FIRMWARE_DIR="bin/targets/x86/64"
        mkdir -p firmware
        # 【代码修正】只拷贝我们需要的 EXT4 格式的 EFI 镜像
        cp -f $FIRMWARE_DIR/*-combined-efi.img.gz firmware/
        echo "FIRMWARE_PATH=openwrt/firmware" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_TAG }}-${{ github.run_id }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: Create release
      if: (github.event_name == 'schedule') || (github.event.inputs.release == 'true') && steps.organize.outputs.status == 'success'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.run_id }}
        body: |
          - Platform: x86/64
          - Filesystem: EXT4 (Writable)
          - Firmware Size: ~1GB
          - Branch: ${{ env.REPO_BRANCH }}
          - Packages: ${{ env.EXTRA_PACKAGES }}
        files: ${{ env.FIRMWARE_PATH }}/*
