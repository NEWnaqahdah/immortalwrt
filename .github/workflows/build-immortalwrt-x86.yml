#
# =================================================================
#         ImmortalWrt x86-64 固件编译 GitHub Actions 最终配置文件
# =================================================================
#
# 功能:
#   - 专为 x86-64 平台编译
#   - 使用稳定版 ImmortalWrt，确保插件兼容性 (.ipk 格式)
#   - 自动包含 EFI 引导支持，适用于现代物理机和虚拟机
#   - 可在 GitHub Actions 页面自定义插件和版本
#
# =================================================================
#

name: Build ImmortalWrt (x86-64)

on:
  # 允许在 GitHub Actions 页面手动触发此工作流程
  workflow_dispatch:
    inputs:
      # 【关键】要编译的 ImmortalWrt 分支，推荐使用稳定版
      version:
        description: 'ImmortalWrt version (branch)'
        required: true
        default: 'openwrt-23.05'
      # 【关键】需要集成的插件列表，用空格隔开
      packages:
        description: 'Extra packages (use space to separate)'
        required: false
        default: 'luci luci-i18n-base-zh-cn luci-app-upnp luci-app-passwall2 luci-app-vlmcsd luci-theme-argon'
      # 是否发布到 GitHub Releases，方便下载
      release:
        description: 'Release firmware to Github Releases'
        required: true
        default: 'true'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: ${{ github.event.inputs.version }}
  EXTRA_PACKAGES: ${{ github.event.inputs.packages }}
  CONFIG_FILE: .config
  FIRMWARE_TAG: ImmortalWrt-x86

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 步骤1：检出仓库代码
    - name: Checkout
      uses: actions/checkout@v4

    # 步骤2：初始化编译环境
    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 aria2 autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mlocate mt-st quilt rsync subversion swig texinfo uglifyjs upx-ucl unzip vim-common wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean

    # 步骤3：清理磁盘空间 (可选但强烈建议)
    - name: Free up disk space
      run: |
        echo "Cleaning up disk space..."
        sudo docker rmi $(docker images -q)
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    # 步骤4：克隆 ImmortalWrt 源码
    - name: Clone source code
      run: git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt

    # 步骤5：更新并安装 Feeds
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 步骤6：生成 x86 专用 .config 文件
    - name: Generate .config for x86
      run: |
        cd openwrt
        # 清空并写入基础配置
        echo "CONFIG_TARGET_x86=y" > $CONFIG_FILE
        echo "CONFIG_TARGET_x86_64=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_DEVICE_x86_64_Generic=y" >> $CONFIG_FILE
        # 写入 EFI 和 GPT 支持
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IMAGES_GPT=y" >> $CONFIG_FILE
        echo "CONFIG_GRUB_EFI_IMAGES=y" >> $CONFIG_FILE
        # 设置根分区大小为 512MB，防止空间不足
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> $CONFIG_FILE

        # 写入自定义插件列表
        if [ -n "$EXTRA_PACKAGES" ]; then
          echo "$EXTRA_PACKAGES" | sed 's/ /\n/g' >> extra_packages.list
          echo -e "\n# Add extra packages" >> $CONFIG_FILE
          while read -r package; do
            echo "CONFIG_PACKAGE_${package}=y" >> $CONFIG_FILE
          done < extra_packages.list
        fi
        
        # 应用默认设置并生成最终 .config
        make defconfig

    # 步骤7：下载依赖包
    - name: Download package
      run: |
        cd openwrt
        make download -j$(nproc)

    # 步骤8：开始编译固件
    - name: Build firmware
      run: |
        cd openwrt
        echo -e "$(nproc) thread build."
        make -j$(nproc)

    # 步骤9：整理输出文件
    - name: Organize files
      id: organize
      run: |
        cd openwrt
        FIRMWARE_DIR="bin/targets/x86/64"
        mkdir -p firmware
        # 复制两种最常用的固件格式
        cp -f $FIRMWARE_DIR/*-combined-efi.img.gz firmware/
        cp -f $FIRMWARE_DIR/*-generic-squashfs-rootfs.img.gz firmware/
        echo "FIRMWARE_PATH=openwrt/firmware" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # 步骤10：上传固件到构建产物 (Artifacts)
    - name: Upload firmware to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_TAG }}-${{ github.run_id }}
        path: ${{ env.FIRMWARE_PATH }}

    # 步骤11：发布固件到 GitHub Release
    - name: Create release
      if: github.event.inputs.release == 'true' && steps.organize.outputs.status == 'success'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.run_id }}
        body: |
          - Platform: x86/64
          - Branch: ${{ env.REPO_BRANCH }}
          - Packages: ${{ env.EXTRA_PACKAGES }}
        files: ${{ env.FIRMWARE_PATH }}/*
